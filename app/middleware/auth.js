const { UnauthenticatedError, UnauthorizedError } = require('../errors');
const { isTokenValid } = require('../utils/jwt');

const authenticateUser = async (req, res, next) => {
  try {
    let token;

    const authHeader = req.headers.authorization;

    if (authHeader && authHeader.startsWith('Bearer')) {
      token = authHeader.split(' ')[1];
    }

    if (!token) {
      throw new UnauthenticatedError('Authenticated Invalid');
    }

    const payload = isTokenValid({ token });

    req.user = {
      email: payload.email,
      role: payload.role,
      name: payload.name,
      organizer: payload.organizer,
      id: payload.userId,
    }

    next();
  } catch (err) {
    next(err);
  }
};

const authorizeRoles = (...roles) => {
  return (req, res, next) => {
    /**
      req.user.role akan berisi role dari akun yang masuk seperti admin, atau organizer
      nah jika kita memasukkan argumen ke dalam ..roles misal 'organizer' maka  
      akun dengan role organizer akan bisa akses route dengan middleeware ini.
      kenapa bisa? karena nilai roles akan dicocokan dengan role akun yang masuk yang
      dibawa token hasil middleware authenticateUser
     */
    if (!roles.includes(req.user.role)) {
      throw new UnauthorizedError('Unauthorized to access this route');
    }
    next();
  };
};

module.exports = {
  authenticateUser,
  authorizeRoles,
};
